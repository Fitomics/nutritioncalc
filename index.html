<!DOCTYPE html>
<html>
<head>
  <title>Fitomics Nutrition Calculator</title>
  <style>
    /* Define our color variables */
    :root {
      --primary-bg: #2b2e82;       /* Light blue */
      --secondary-bg: #fff8e1;     /* Light gold */
      --accent-color: #ffcc80;     /* Warm accent (gold-ish) */
      --text-color: #333;
      --border-color: #ccc;
      /* Both placeholder (empty computed fields) and calculated fields use light blue */
      --input-bg-placeholder: rgba(43, 46, 130, 0.3); /* Transparent dark blue */
      --input-bg-calculated: var(--primary-bg);
    }

    /* Global resets and fonts */
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--primary-bg);
      color: var(--text-color);
    }

    /* Center content and add some spacing */
    .container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 1rem;
    }

    h1 {
      text-align: center;
      margin-bottom: 1.5rem;
      color: var(--accent-color);
    }

    /* Style the form “card” */
    form {
      background-color: #fff;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    /* Grid layout for the form fields */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    /* Each label+input group */
    .form-group {
      display: flex;
      flex-direction: column;
    }
    /* Make items span full width if needed (like tables or headings) */
    .form-group.full-width {
      grid-column: 1 / -1;
    }

    label {
      margin-bottom: 0.5rem;
      font-weight: bold;
    }

    input[type="number"],
    input[type="text"],
    select {
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: #fff;
      font-size: 1rem;
    }

    /* Computed (read-only) fields use these classes.
       Now, if data is not available (i.e. still the default state),
       they show a light blue background. */
    .placeholder {
      background-color: var(--input-bg-placeholder);
    }
    .calculated {
      background-color: var(--input-bg-calculated);
    }

    /* Style tables to match our color scheme */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
    }
    th, td {
      border: 1px solid var(--border-color);
      padding: 0.75rem;
      text-align: left;
    }
    th {
      background-color: var(--secondary-bg);
    }

    h2 {
      margin-top: 1.5rem;
      color: var(--accent-color);
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 0.5rem;
    }
  </style>
  <!-- Add SQLite library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
</head>
<body>
  <div class="container">
    <h1>Fitomics Nutrition Calculator</h1>
    <form>
      <div class="form-grid">
        <!-- Personal Information -->
        <div class="form-group">
          <label for="age">Enter Age (Years):</label>
          <input type="number" id="age" name="age">
        </div>
        <div class="form-group">
          <label for="gender">Select Gender:</label>
          <select id="gender" name="gender">
            <option value="male">Male</option>
            <option value="female">Female</option>
          </select>
        </div>
        <div class="form-group">
          <label for="height">Enter Height (Inches):</label>
          <input type="number" id="height" name="height">
        </div>
        <div class="form-group">
          <label for="weight">Enter Weight (Pounds):</label>
          <input type="number" id="weight" name="weight">
        </div>
        <div class="form-group">
          <label for="bodyfat">Enter Body Fat %:</label>
          <input type="number" id="bodyfat" name="bodyfat">
        </div>

        <!-- Calculated Body Composition -->
        <div class="form-group">
          <label for="fat_mass">Fat Mass (lbs):</label>
          <input type="number" id="fat_mass" name="fat_mass" class="placeholder" readonly>
        </div>
        <div class="form-group">
          <label for="fat_free_mass">Fat-Free Mass (lbs):</label>
          <input type="number" id="fat_free_mass" name="fat_free_mass" class="placeholder" readonly>
        </div>
        <div class="form-group">
          <label for="fat_mass_index">Fat Mass Index (kg/m²):</label>
          <input type="number" id="fat_mass_index" name="fat_mass_index" class="placeholder" readonly>
        </div>
        <div class="form-group">
          <label for="fat_free_mass_index">Fat-Free Mass Index (kg/m²):</label>
          <input type="number" id="fat_free_mass_index" name="fat_free_mass_index" class="placeholder" readonly>
        </div>
        <div class="form-group">
          <label for="bmi">Body Mass Index (kg/m²):</label>
          <input type="number" id="bmi" name="bmi" class="placeholder" readonly>
        </div>
        <div class="form-group">
          <label for="rmr">Estimated Resting Metabolic Rate (RMR):</label>
          <input type="text" id="rmr" class="placeholder" readonly>
        </div>

        <!-- Activity and Workout -->
        <div class="form-group">
          <label for="activity">Activity Level (table below):</label>
          <select id="activity" name="activity">
            <option value="1.1">1.1</option>
            <option value="1.15">1.15</option>
            <option value="1.2">1.2</option>
            <option value="1.3">1.3</option>
            <option value="1.4">1.4</option>
            <option value="1.5">1.5</option>
            <option value="1.6">1.6</option>
            <option value="1.7">1.7</option>
          </select>
        </div>
        <!-- Activity explanation table -->
        <div class="form-group full-width">
          <table>
            <tr>
              <th>Activity Status</th>
              <th>Multiplier</th>
              <th>Steps</th>
            </tr>
            <tr>
              <td>Sedentary</td>
              <td>1.1-1.15</td>
              <td>0-5000</td>
            </tr>
            <tr>
              <td>Light Active</td>
              <td>1.2-1.3</td>
              <td>5,000-10,000</td>
            </tr>
            <tr>
              <td>Active</td>
              <td>1.3-1.5</td>
              <td>10,000-15,000</td>
            </tr>
            <tr>
              <td>Labour Intensive</td>
              <td>1.5-1.7</td>
              <td>>15,000</td>
            </tr>
          </table>
        </div>
        <div class="form-group">
          <label for="workout_calories">Enter Average Calories Expended During a Workout:</label>
          <input type="number" id="workout_calories" name="workout_calories">
        </div>
        <div class="form-group">
          <label for="workouts_per_week">Enter Average Workouts Per Week:</label>
          <input type="number" id="workouts_per_week" name="workouts_per_week">
        </div>
        <div class="form-group">
          <label for="predicted_daily_calorie_burn">Predicted Daily Calorie Burn (kcal):</label>
          <input type="number" id="predicted_daily_calorie_burn" name="predicted_daily_calorie_burn" class="placeholder" readonly>
        </div>
        <div class="form-group">
          <label for="goal">Multiplier for Goal (table below):</label>
          <select id="goal" name="goal">
            <option value="0.8">0.8</option>
            <option value="0.85">0.85</option>
            <option value="0.9">0.9</option>
            <option value="1">1</option>
            <option value="1.1">1.1</option>
            <option value="1.15">1.15</option>
            <option value="1.2">1.2</option>
          </select>
        </div>
        <!-- Goal explanation table -->
        <div class="form-group full-width">
          <table>
            <tr>
              <th>Goal</th>
              <th>Multiplier</th>
            </tr>
            <tr>
              <td>Maintenance</td>
              <td>1</td>
            </tr>
            <tr>
              <td>Fat Loss</td>
              <td>0.8-0.9</td>
            </tr>
            <tr>
              <td>Muscle Gain</td>
              <td>1.1-1.2</td>
            </tr>
          </table>
        </div>

        <!-- Nutrient selection and Results -->
        <div class="form-group full-width">
          <h2>Results:</h2>
        </div>
        <div class="form-group">
          <label for="protein">Protein (grams/kilogram):</label>
          <select id="protein" name="protein">
            <option value="0.8">0.8</option>
            <option value="1.0">1.0</option>
            <option value="1.2" selected>1.2</option>
            <option value="1.4">1.4</option>
            <option value="1.8">1.8</option>
            <option value="2.0">2.0</option>
            <option value="2.2">2.2</option>
          </select>
        </div>
        <div class="form-group">
          <label for="fat">Fat (Percent of Calories):</label>
          <select id="fat" name="fat">
            <option value="0.2">20%</option>
            <option value="0.25">25%</option>
            <option value="0.3" selected>30%</option>
            <option value="0.35">35%</option>
            <option value="0.4">40%</option>
          </select>
        </div>
        <!-- Results table -->
        <div class="form-group full-width">
          <table id="resultsTable">
            <tr>
              <th>Nutrient</th>
              <th>Value</th>
              <th>Calculated Amount</th>
              <th>Calculated Calories</th>
            </tr>
            <tr>
              <td>Target Energy Range (kcal)</td>
              <td colspan="3" id="target_energy"></td>
            </tr>
            <tr>
              <td>Protein</td>
              <td id="protein_value"></td>
              <td id="protein_grams"></td>
              <td id="protein_calories"></td>
            </tr>
            <tr>
              <td>Fat</td>
              <td id="fat_percentage"></td>
              <td id="fat_grams"></td>
              <td id="fat_calories"></td>
            </tr>
            <tr>
              <td>Carbs</td>
              <td id="carb_percentage"></td>
              <td id="carb_grams"></td>
              <td id="carb_calories"></td>
            </tr>
            <tr>
              <td>Fiber</td>
              <td id="fiber_value"></td>
              <td id="fiber_grams"></td>
              <!--<td id="fiber_calories"></td>-->
            </tr>
            <tr>
              <td>Fluid Intake</td>
              <td id="fluid_ml_per_kg"></td>
              <td id="fluid_total"></td>
              <td></td>
            </tr>
          </table>
        </div>
      </div>
    </form>
  </div>

  <script>
    let db;
  
    async function initDatabase() {
      const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${file}` });
      const savedDb = localStorage.getItem('nutritionDb');
      if (savedDb) {
        const uInt8Array = new Uint8Array(JSON.parse(savedDb));
        db = new SQL.Database(uInt8Array);
      } else {
        db = new SQL.Database();
        db.run(`CREATE TABLE IF NOT EXISTS nutrition (key TEXT PRIMARY KEY, value TEXT)`);
      }
    }
  
    function saveToDatabase(key, value) {
      db.run(`INSERT OR REPLACE INTO nutrition (key, value) VALUES (?, ?)`, [key, value]);
      const data = db.export();
      localStorage.setItem('nutritionDb', JSON.stringify(Array.from(data)));
      localStorage.setItem(key, value);
    }
  
    function loadFromDatabase(key) {
      const stmt = db.prepare(`SELECT value FROM nutrition WHERE key = ?`);
      stmt.bind([key]);
      if (stmt.step()) {
        return stmt.getAsObject().value;
      }
      return localStorage.getItem(key);
    }
  
    function calculateValues() {
      const weight = parseFloat(document.getElementById('weight').value);
      const bodyFat = parseFloat(document.getElementById('bodyfat').value);
      const height = parseFloat(document.getElementById('height').value);
      const gender = document.getElementById('gender').value;
      const age = parseFloat(document.getElementById('age').value);
  
      if (!isNaN(weight) && !isNaN(bodyFat) && !isNaN(height) && !isNaN(age)) {
        // Calculate basic body composition
        const fatMass = (bodyFat / 100) * weight;
        const fatFreeMass = weight - fatMass;
        document.getElementById('fat_mass').value = fatMass.toFixed(2);
        document.getElementById('fat_free_mass').value = fatFreeMass.toFixed(2);
        document.getElementById('fat_mass').classList.remove('placeholder');
        document.getElementById('fat_mass').classList.add('calculated');
        document.getElementById('fat_free_mass').classList.remove('placeholder');
        document.getElementById('fat_free_mass').classList.add('calculated');
  
        const weightkg = weight / 2.204;
        const heightcm = height * 2.53;
        const heightm = heightcm / 100;
        const fatMassIndex = (weightkg * (bodyFat / 100)) / (heightm * heightm);
        const fatFreeMassIndex = (weightkg * (1 - bodyFat / 100)) / (heightm * heightm);
        const bmi = weightkg / (heightm * heightm);
  
        document.getElementById('fat_mass_index').value = fatMassIndex.toFixed(2);
        document.getElementById('fat_free_mass_index').value = fatFreeMassIndex.toFixed(2);
        document.getElementById('bmi').value = bmi.toFixed(2);
  
        document.getElementById('fat_mass_index').classList.remove('placeholder');
        document.getElementById('fat_mass_index').classList.add('calculated');
        document.getElementById('fat_free_mass_index').classList.remove('placeholder');
        document.getElementById('fat_free_mass_index').classList.add('calculated');
        document.getElementById('bmi').classList.remove('placeholder');
        document.getElementById('bmi').classList.add('calculated');
  
        // Calculate RMR using the Mifflin-St Jeor equation
        let rmr;
        if (gender === 'male') {
          rmr = 10 * weightkg + 6.25 * heightcm - 5 * age + 5;
        } else {
          rmr = 10 * weightkg + 6.25 * heightcm - 5 * age - 161;
        }
  
        document.getElementById('rmr').value = rmr.toFixed(0);
        document.getElementById('rmr').classList.remove('placeholder');
        document.getElementById('rmr').classList.add('calculated');
  
        // Calculate predicted daily calorie burn
        const weeklyWorkoutCalories = parseFloat(document.getElementById('workout_calories').value) * parseFloat(document.getElementById('workouts_per_week').value);
        const averageDailyWorkoutCalories = weeklyWorkoutCalories / 7;
        const predictedDailyCalorieBurn = rmr * parseFloat(document.getElementById('activity').value) + averageDailyWorkoutCalories;
        const goalMultiplier = parseFloat(document.getElementById('goal').value);
        const targetEnergy = predictedDailyCalorieBurn * goalMultiplier;
  
        document.getElementById('predicted_daily_calorie_burn').value = predictedDailyCalorieBurn.toFixed(0);
        document.getElementById('predicted_daily_calorie_burn').classList.remove('placeholder');
        document.getElementById('predicted_daily_calorie_burn').classList.add('calculated');
  
        // Update the results table
  
        // Target Energy Range
        document.getElementById('target_energy').textContent = targetEnergy.toFixed(0);
  
        // Protein: use the selected grams/kg factor and calculate total protein grams
        const proteinFactor = parseFloat(document.getElementById('protein').value);
        document.getElementById('protein_value').textContent = proteinFactor.toFixed(2) + " g/kg";
        const proteinGrams = weightkg * proteinFactor;
        document.getElementById('protein_grams').textContent = proteinGrams.toFixed(0) + " g";
        const proteinCalories = proteinGrams * 4;
        document.getElementById('protein_calories').textContent = proteinCalories.toFixed(0) + " kcal";
  
        // Fat: display the percentage (multiplied by 100) and calculate fat grams
        const fatPercentage = parseFloat(document.getElementById('fat').value);
        document.getElementById('fat_percentage').textContent = (fatPercentage * 100).toFixed(0) + "%";
        const fatGrams = (targetEnergy * fatPercentage) / 9;
        document.getElementById('fat_grams').textContent = fatGrams.toFixed(0) + " g";
        const fatCalories = fatGrams * 9;
        document.getElementById('fat_calories').textContent = fatCalories.toFixed(0) + " kcal";
  
        // Fiber: the recommendation is 14 g per 1000 kcal; show both the recommendation and the total grams
        const fiberGrams = (targetEnergy / 1000) * 14;
        document.getElementById('fiber_value').textContent = "14 g/1000kcal";
        document.getElementById('fiber_grams').textContent = fiberGrams.toFixed(0) + " g";
        const fiberCalories = fiberGrams * 2;  // Assume 2 kcal per gram for fiber
        // document.getElementById('fiber_calories').textContent = fiberCalories.toFixed(2) + " kcal";
  
        // Carbs: Calculate remaining calories after protein, fat, and possibly fiber, leaving out fiber calories for now
        // then compute grams (4 kcal/g) and percent of total calories.
        const remainingCarbCalories = targetEnergy - (proteinCalories + fatCalories /*+ fiberCalories*/);
        const carbGrams = remainingCarbCalories > 0 ? remainingCarbCalories / 4 : 0;
        const carbPercentage = targetEnergy > 0 ? (remainingCarbCalories / targetEnergy) * 100 : 0;
        document.getElementById('carb_percentage').textContent = carbPercentage.toFixed(2) + " %";
        document.getElementById('carb_grams').textContent = carbGrams.toFixed(0) + " g";
        document.getElementById('carb_calories').textContent = remainingCarbCalories.toFixed(0) + " kcal";
  
        // Fluid: show 40 ml/kg/day on the left and the total fluid volume on the right
        const fluidIntake = weightkg * 40;
        document.getElementById('fluid_ml_per_kg').textContent = "40 ml/kg/day";
        document.getElementById('fluid_total').textContent = fluidIntake.toFixed(0) + " ml";
  
        // Save key values to the database/local storage
        saveToDatabase('age', age);
        saveToDatabase('weight', weight);
        saveToDatabase('bodyfat', bodyFat);
        saveToDatabase('height', height);
        saveToDatabase('gender', gender);
        saveToDatabase('activity', document.getElementById('activity').value);
        saveToDatabase('workout_calories', document.getElementById('workout_calories').value);
        saveToDatabase('workouts_per_week', document.getElementById('workouts_per_week').value);
        saveToDatabase('goal', document.getElementById('goal').value);
        saveToDatabase('protein', document.getElementById('protein').value);
        saveToDatabase('fat', document.getElementById('fat').value);
      } else {
        // Ensure placeholder color is applied if values are not calculated
        document.querySelectorAll('.placeholder').forEach(element => {
          element.classList.add('placeholder');
          element.classList.remove('calculated');
        });
      }
    }
  
    document.addEventListener('DOMContentLoaded', async () => {
      await initDatabase();
      document.getElementById('age').value = loadFromDatabase('age') || '';
      document.getElementById('weight').value = loadFromDatabase('weight') || '';
      document.getElementById('bodyfat').value = loadFromDatabase('bodyfat') || '';
      document.getElementById('height').value = loadFromDatabase('height') || '';
      document.getElementById('gender').value = loadFromDatabase('gender') || 'male';
      document.getElementById('activity').value = loadFromDatabase('activity') || '1.1';
      document.getElementById('workout_calories').value = loadFromDatabase('workout_calories') || '';
      document.getElementById('workouts_per_week').value = loadFromDatabase('workouts_per_week') || '';
      document.getElementById('goal').value = loadFromDatabase('goal') || '1';
      document.getElementById('protein').value = loadFromDatabase('protein') || '1.2';
      document.getElementById('fat').value = loadFromDatabase('fat') || '0.3';
      calculateValues(); // Calculate values based on loaded data
    });
  
    document.querySelectorAll('input, select').forEach(input => {
    input.addEventListener('change', (event) => {
    const key = event.target.id;
    const value = event.target.value;
    saveToDatabase(key, value);
    calculateValues(); // Recalculate values as soon as the value changes
  });
});
  </script>
</body>
</html>
